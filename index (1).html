<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wavelength</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --sidebar-bg: #111117;
    --card-bg: #16161e;
    --hover-bg: #1e1e2a;
    --accent: #1db954;
    --accent-glow: rgba(29,185,84,0.3);
    --text-primary: #ffffff;
    --text-secondary: #a0a0b8;
    --text-muted: #5a5a78;
    --border: rgba(255,255,255,0.07);
    --player-bg: #0d0d14;
    --progress-bg: #2a2a3a;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    user-select: none;
  }
  .app {
    display: grid;
    grid-template-columns: 260px 1fr;
    grid-template-rows: 1fr 90px;
    height: 100vh;
    gap: 8px;
    padding: 8px 8px 0;
    overflow: hidden;
  }
  .sidebar {
    background: var(--sidebar-bg);
    border-radius: 12px;
    padding: 24px 16px;
    display: flex;
    flex-direction: column;
    gap: 28px;
    overflow: hidden;
  }
  .logo { display:flex; align-items:center; gap:10px; padding:0 8px; }
  .logo-icon {
    width:36px; height:36px; background:var(--accent); border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 0 24px var(--accent-glow); flex-shrink:0;
  }
  .logo-icon svg { width:18px; height:18px; fill:#000; }
  .logo-text { font-size:17px; font-weight:700; letter-spacing:-0.5px; }
  .nav { display:flex; flex-direction:column; gap:4px; }
  .nav-item {
    display:flex; align-items:center; gap:14px;
    padding:10px 12px; border-radius:8px; cursor:pointer;
    color:var(--text-secondary); font-size:14px; font-weight:500; transition:all 0.15s;
  }
  .nav-item:hover { background:var(--hover-bg); color:var(--text-primary); }
  .nav-item.active { color:var(--text-primary); }
  .nav-item svg { width:20px; height:20px; flex-shrink:0; }
  .sidebar-section { flex:1; display:flex; flex-direction:column; overflow:hidden; min-height:0; }
  .sbar-hdr {
    display:flex; justify-content:space-between; align-items:center;
    padding:8px 12px; color:var(--text-muted);
    font-size:11px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; margin-bottom:6px;
  }
  .sbar-hdr-btns { display:flex; gap:4px; }
  .icon-btn {
    width:26px; height:26px; background:none; border:none; cursor:pointer;
    color:var(--text-muted); display:flex; align-items:center; justify-content:center;
    border-radius:6px; transition:all 0.15s;
  }
  .icon-btn:hover { color:var(--text-primary); background:var(--hover-bg); }
  .icon-btn svg { width:15px; height:15px; }
  .playlist { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:2px; }
  .playlist::-webkit-scrollbar { width:4px; }
  .playlist::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
  .pitem {
    display:flex; align-items:center; gap:10px;
    padding:8px 12px; border-radius:8px; cursor:pointer; transition:background 0.15s; position:relative;
  }
  .pitem:hover { background:var(--hover-bg); }
  .pitem:hover .pi-del { opacity:1; }
  .pitem.active { background:var(--hover-bg); }
  .pitem.active .pi-name { color:var(--accent); }
  .pi-num { width:18px; text-align:center; font-size:13px; color:var(--text-muted); flex-shrink:0; }
  .pitem.active .pi-num { display:none; }
  .pi-bars { display:none; width:18px; flex-shrink:0; align-items:center; justify-content:center; }
  .pitem.active .pi-bars { display:flex; }
  .bars { display:flex; align-items:flex-end; gap:2px; height:14px; }
  .bars span { width:3px; background:var(--accent); border-radius:2px; animation:bar 0.8s ease infinite; }
  .bars span:nth-child(2) { animation-delay:0.2s; }
  .bars span:nth-child(3) { animation-delay:0.4s; }
  @keyframes bar { 0%,100%{height:4px} 50%{height:14px} }
  .pi-art {
    width:36px; height:36px; border-radius:6px; background:var(--card-bg);
    flex-shrink:0; display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .pi-art svg { width:14px; height:14px; color:var(--text-muted); }
  .pi-info { flex:1; min-width:0; }
  .pi-name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pi-artist { font-size:12px; color:var(--text-muted); margin-top:1px; }
  .pi-dur { font-size:12px; color:var(--text-muted); flex-shrink:0; }
  .pi-del {
    opacity:0; background:none; border:none; cursor:pointer;
    color:var(--text-muted); padding:2px; border-radius:4px; transition:all 0.15s;
    display:flex; align-items:center; flex-shrink:0;
  }
  .pi-del:hover { color:#ff4d4d; }
  .pi-del svg { width:13px; height:13px; }

  /* MAIN */
  .main { background:var(--sidebar-bg); border-radius:12px; display:flex; flex-direction:column; overflow:hidden; }
  .main-top { padding:28px 32px 0; flex-shrink:0; display:flex; justify-content:space-between; align-items:flex-start; }
  .main-top-left h1 { font-size:28px; font-weight:700; letter-spacing:-0.5px; }
  .main-top-left p { font-size:14px; color:var(--text-secondary); margin-top:4px; }
  .storage-badge {
    font-size:11px; color:var(--text-muted); background:var(--card-bg);
    padding:5px 10px; border-radius:20px; display:flex; align-items:center; gap:6px;
    border:1px solid var(--border); margin-top:4px;
  }
  .storage-dot { width:6px; height:6px; border-radius:50%; background:var(--accent); flex-shrink:0; }

  .upload-zone {
    margin:20px 32px 0; flex-shrink:0;
    border:2px dashed var(--border); border-radius:12px;
    padding:20px 32px; text-align:center; cursor:pointer; transition:all 0.2s;
    background:rgba(29,185,84,0.02);
  }
  .upload-zone:hover, .upload-zone.drag { border-color:var(--accent); background:rgba(29,185,84,0.05); }
  .upload-zone svg { width:32px; height:32px; color:var(--accent); margin:0 auto 8px; display:block; }
  .upload-zone h3 { font-size:14px; font-weight:600; margin-bottom:3px; }
  .upload-zone p { font-size:12px; color:var(--text-secondary); }
  .upload-zone .lnk { color:var(--accent); font-weight:600; }
  #fi { display:none; }

  .tracks-hdr {
    display:grid; grid-template-columns:48px 1fr 140px 80px;
    padding:12px 32px 8px; border-bottom:1px solid var(--border);
    flex-shrink:0; margin-top:16px;
  }
  .tracks-hdr span { font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.08em; }
  .tracks-hdr span:last-child { text-align:right; }

  .tracks-list { flex:1; overflow-y:auto; padding:4px 20px 16px; }
  .tracks-list::-webkit-scrollbar { width:6px; }
  .tracks-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  .trow {
    display:grid; grid-template-columns:48px 1fr 140px 80px;
    align-items:center; padding:8px 12px; border-radius:8px; cursor:pointer; transition:background 0.15s;
    animation:fadeUp 0.2s ease; position:relative;
  }
  .trow:hover { background:var(--hover-bg); }
  .trow:hover .tr-del { opacity:1; }
  .trow.active { background:var(--hover-bg); }
  .tr-num { font-size:14px; color:var(--text-muted); text-align:center; }
  .trow.active .tr-num { display:none; }
  .tr-bars { display:none; align-items:center; justify-content:center; }
  .trow.active .tr-bars { display:flex; }
  .tr-info { display:flex; align-items:center; gap:14px; min-width:0; }
  .tr-art {
    width:44px; height:44px; border-radius:8px; background:var(--card-bg);
    flex-shrink:0; display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .tr-art svg { width:18px; height:18px; color:var(--text-muted); }
  .tr-text h4 { font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px; }
  .trow.active .tr-text h4 { color:var(--accent); }
  .tr-text span { font-size:13px; color:var(--text-secondary); }
  .tr-date { font-size:13px; color:var(--text-muted); }
  .tr-dur-wrap { display:flex; align-items:center; justify-content:flex-end; gap:8px; padding-right:4px; }
  .tr-dur { font-size:13px; color:var(--text-muted); }
  .tr-del {
    opacity:0; background:none; border:none; cursor:pointer;
    color:var(--text-muted); padding:3px; border-radius:4px; transition:all 0.15s;
    display:flex; align-items:center;
  }
  .tr-del:hover { color:#ff4d4d; }
  .tr-del svg { width:14px; height:14px; }

  .empty { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; color:var(--text-muted); gap:10px; padding:60px 0; }
  .empty svg { width:52px; height:52px; opacity:0.2; }
  .empty p { font-size:14px; }

  /* Loading overlay */
  .loading-screen {
    position:fixed; inset:0; background:var(--bg);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:16px; z-index:100; transition:opacity 0.4s;
  }
  .loading-screen.hidden { opacity:0; pointer-events:none; }
  .loading-logo { width:52px; height:52px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 40px var(--accent-glow); animation:pulse 1.5s ease infinite; }
  .loading-logo svg { width:26px; height:26px; fill:#000; }
  @keyframes pulse { 0%,100%{transform:scale(1);box-shadow:0 0 30px var(--accent-glow)} 50%{transform:scale(1.06);box-shadow:0 0 50px var(--accent-glow)} }
  .loading-text { font-size:13px; color:var(--text-muted); letter-spacing:0.05em; }

  /* Toast notification */
  .toast {
    position:fixed; bottom:108px; left:50%; transform:translateX(-50%) translateY(10px);
    background:var(--card-bg); border:1px solid var(--border);
    color:var(--text-primary); font-size:13px; font-weight:500;
    padding:10px 18px; border-radius:20px; opacity:0;
    transition:all 0.3s; pointer-events:none; white-space:nowrap;
    box-shadow:0 4px 20px rgba(0,0,0,0.4); z-index:50;
  }
  .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
  .toast.green { border-color:var(--accent); color:var(--accent); }

  /* PLAYER */
  .player {
    grid-column:1 / -1; background:var(--player-bg); border-top:1px solid var(--border);
    display:grid; grid-template-columns:1fr 2fr 1fr;
    align-items:center; padding:0 24px; height:90px; gap:16px;
  }
  .p-track { display:flex; align-items:center; gap:14px; }
  .p-art {
    width:56px; height:56px; border-radius:8px; background:var(--card-bg);
    flex-shrink:0; display:flex; align-items:center; justify-content:center;
    box-shadow:0 4px 20px rgba(0,0,0,0.5); overflow:hidden;
  }
  .p-art svg { width:22px; height:22px; color:var(--text-muted); }
  .p-info h4 { font-size:14px; font-weight:500; margin-bottom:3px; max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .p-info span { font-size:12px; color:var(--text-secondary); }
  .p-ctrl { display:flex; flex-direction:column; align-items:center; gap:8px; }
  .ctrl-row { display:flex; align-items:center; gap:20px; }
  .cb {
    background:none; border:none; cursor:pointer; color:var(--text-secondary);
    display:flex; align-items:center; justify-content:center;
    border-radius:50%; padding:6px; transition:all 0.15s;
  }
  .cb:hover { color:var(--text-primary); transform:scale(1.05); }
  .cb svg { width:18px; height:18px; }
  .cb.on { color:var(--accent); }
  .pbtn {
    width:40px; height:40px; background:#fff; border:none;
    border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s;
  }
  .pbtn:hover { transform:scale(1.06); background:#e0e0e0; }
  .pbtn svg { width:18px; height:18px; fill:#000; margin-left:2px; }
  .pbtn.playing svg { margin-left:0; }
  .prog-row { display:flex; align-items:center; gap:10px; width:100%; }
  .tl { font-size:11px; color:var(--text-muted); min-width:36px; font-feature-settings:'tnum'; }
  .tl:last-child { text-align:right; }
  .prog { flex:1; height:4px; background:var(--progress-bg); border-radius:2px; cursor:pointer; transition:height 0.1s; }
  .prog:hover { height:6px; }
  .prog-fill { height:100%; background:#fff; border-radius:2px; pointer-events:none; transition:background 0.15s; }
  .prog:hover .prog-fill { background:var(--accent); }
  .p-right { display:flex; align-items:center; justify-content:flex-end; gap:12px; }
  .vol-row { display:flex; align-items:center; gap:8px; }
  .vi { background:none; border:none; cursor:pointer; color:var(--text-secondary); display:flex; align-items:center; transition:color 0.15s; }
  .vi:hover { color:var(--text-primary); }
  .vi svg { width:18px; height:18px; }
  .vs { width:80px; height:4px; background:var(--progress-bg); border-radius:2px; cursor:pointer; transition:height 0.1s; }
  .vs:hover { height:6px; }
  .vf { height:100%; background:var(--text-secondary); border-radius:2px; pointer-events:none; transition:background 0.15s; }
  .vs:hover .vf { background:var(--accent); }
  audio { display:none; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<!-- Loading screen shown while IndexedDB loads saved songs -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">
    <svg viewBox="0 0 24 24"><path d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6z"/></svg>
  </div>
  <div class="loading-text">Loading your library…</div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="fi" multiple accept="audio/*,.mp3,.flac,.wav,.aac,.m4a,.ogg,.opus">
<audio id="aud"></audio>

<div class="app">
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24"><path d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6z"/></svg>
      </div>
      <span class="logo-text">Wavelength</span>
    </div>
    <nav class="nav">
      <div class="nav-item active">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        Home
      </div>
      <div class="nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        Search
      </div>
    </nav>
    <div class="sidebar-section">
      <div class="sbar-hdr">
        Library
        <div class="sbar-hdr-btns">
          <button class="icon-btn" onclick="document.getElementById('fi').click()" title="Add songs">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
          </button>
          <button class="icon-btn" onclick="clearAll()" title="Clear library" id="clearBtn" style="display:none">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
          </button>
        </div>
      </div>
      <div class="playlist" id="sbar"></div>
    </div>
  </aside>

  <main class="main">
    <div class="main-top">
      <div class="main-top-left">
        <h1>Your Library</h1>
        <p id="cnt">Loading…</p>
      </div>
      <div class="storage-badge" id="storageBadge" style="display:none">
        <div class="storage-dot"></div>
        <span id="storageInfo">Saved locally</span>
      </div>
    </div>
    <div class="upload-zone" id="uz" onclick="document.getElementById('fi').click()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M9 19V6l12-3v13M9 19c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm12 0c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2z"/>
      </svg>
      <h3>Click to add music — or drag & drop here</h3>
      <p>Songs are <span class="lnk">saved permanently</span> in your browser · MP3, FLAC, WAV, AAC, M4A</p>
    </div>
    <div class="tracks-hdr" id="thdr" style="display:none">
      <span>#</span><span>Title</span><span>Added</span><span style="text-align:right">Duration</span>
    </div>
    <div class="tracks-list" id="tlist"></div>
  </main>

  <div class="player">
    <div class="p-track">
      <div class="p-art" id="part">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6z"/></svg>
      </div>
      <div class="p-info">
        <h4 id="ptitle">No track selected</h4>
        <span id="partist">—</span>
      </div>
    </div>
    <div class="p-ctrl">
      <div class="ctrl-row">
        <button class="cb" id="shuf" onclick="toggleShuffle()" title="Shuffle">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/>
            <polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/>
          </svg>
        </button>
        <button class="cb" onclick="prev()">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
        </button>
        <button class="pbtn" id="pbtn" onclick="togglePlay()">
          <svg id="pico" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
        </button>
        <button class="cb" onclick="next()">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        </button>
        <button class="cb" id="rep" onclick="toggleRepeat()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/>
            <polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
          </svg>
        </button>
      </div>
      <div class="prog-row">
        <span class="tl" id="cur">0:00</span>
        <div class="prog" id="pbar" onclick="seek(event)">
          <div class="prog-fill" id="pfill" style="width:0%"></div>
        </div>
        <span class="tl" id="tot">0:00</span>
      </div>
    </div>
    <div class="p-right">
      <div class="vol-row">
        <button class="vi" onclick="toggleMute()">
          <svg id="vico" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
          </svg>
        </button>
        <div class="vs" id="vs" onclick="setVol(event)">
          <div class="vf" id="vf" style="width:70%"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ─── IndexedDB setup ──────────────────────────────────────────────────────────
const DB_NAME = 'WavelengthDB';
const DB_VER = 1;
const STORE = 'tracks';
let db = null;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains(STORE)) {
        const store = d.createObjectStore(STORE, { keyPath: 'id' });
        store.createIndex('addedAt', 'addedAt', { unique: false });
      }
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = e => reject(e.target.error);
  });
}

function dbGetAll() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readonly');
    const req = tx.objectStore(STORE).index('addedAt').getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = e => reject(e.target.error);
  });
}

function dbPut(track) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).put(track);
    req.onsuccess = () => resolve();
    req.onerror = e => reject(e.target.error);
  });
}

function dbDelete(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).delete(id);
    req.onsuccess = () => resolve();
    req.onerror = e => reject(e.target.error);
  });
}

function dbClear() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).clear();
    req.onsuccess = () => resolve();
    req.onerror = e => reject(e.target.error);
  });
}

// ─── App state ────────────────────────────────────────────────────────────────
const aud = document.getElementById('aud');
let tracks = [];   // { id, name, dur, addedAt, blob, url }
let ci = -1, playing = false, shuffle = false, repeat = false, muted = false, vol = 0.7;
aud.volume = vol;

const NOTE = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6z"/></svg>`;
const BARS = `<div class="bars"><span></span><span></span><span></span></div>`;

// ─── Toast ────────────────────────────────────────────────────────────────────
let toastTimer;
function showToast(msg, green = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (green ? ' green' : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.className = 'toast', 2500);
}

// ─── File input & drag/drop ───────────────────────────────────────────────────
document.getElementById('fi').addEventListener('change', e => {
  handleFiles([...e.target.files]); e.target.value = '';
});
document.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('uz').classList.add('drag'); });
document.addEventListener('dragleave', e => { if (!e.relatedTarget) document.getElementById('uz').classList.remove('drag'); });
document.addEventListener('drop', e => {
  e.preventDefault(); document.getElementById('uz').classList.remove('drag');
  const files = [...e.dataTransfer.files].filter(f =>
    f.type.startsWith('audio/') || /\.(mp3|flac|wav|aac|m4a|ogg|opus)$/i.test(f.name)
  );
  if (files.length) handleFiles(files);
});

async function handleFiles(files) {
  let added = 0;
  for (const f of files) {
    // Skip duplicates by name+size
    const exists = tracks.some(t => t.name === f.name.replace(/\.[^.]+$/, '') && t.size === f.size);
    if (exists) continue;

    const id = Date.now() + '-' + Math.random().toString(36).slice(2);
    const name = f.name.replace(/\.[^.]+$/, '');

    // Read the actual binary bytes — this is what persists across sessions
    const arrayBuffer = await f.arrayBuffer();

    const track = {
      id, name,
      size: f.size,
      type: f.type || 'audio/mpeg',
      dur: '—',
      addedAt: Date.now(),
      data: arrayBuffer   // raw bytes, survives page close
    };
    // Save to IndexedDB first
    await dbPut(track);
    // Create a playable blob URL from the bytes
    track.url = URL.createObjectURL(new Blob([arrayBuffer], { type: track.type }));
    tracks.push(track);
    added++;
  }
  if (added > 0) {
    render();
    updateStorageInfo();
    showToast(`✓ Added ${added} song${added !== 1 ? 's' : ''} — saved to your library`, true);
    if (ci === -1) play(0);
  } else {
    showToast('Songs already in your library');
  }
}

// ─── Load saved tracks from IndexedDB on startup ──────────────────────────────
async function loadSavedTracks() {
  try {
    await openDB();

    // Request persistent storage so browser won't evict our data
    if (navigator.storage && navigator.storage.persist) {
      await navigator.storage.persist(); // silently granted on most sites
    }

    const saved = await dbGetAll();
    for (const t of saved) {
      if (!t.data) continue; // skip any old malformed entries
      // Reconstruct a playable blob URL from the stored raw bytes
      t.url = URL.createObjectURL(new Blob([t.data], { type: t.type || 'audio/mpeg' }));
      tracks.push(t);
    }
    render();
    updateStorageInfo();
  } catch (err) {
    console.error('DB load error:', err);
    showToast('Could not load saved library');
  } finally {
    const ls = document.getElementById('loadingScreen');
    ls.classList.add('hidden');
    setTimeout(() => ls.remove(), 500);
  }
}

// ─── Delete track ─────────────────────────────────────────────────────────────
async function deleteTrack(id, e) {
  e.stopPropagation();
  const idx = tracks.findIndex(t => t.id === id);
  if (idx === -1) return;

  // Revoke blob URL to free memory
  URL.revokeObjectURL(tracks[idx].url);
  await dbDelete(id);
  tracks.splice(idx, 1);

  // Adjust current index
  if (ci === idx) {
    aud.pause(); aud.src = '';
    playing = false; ci = -1;
    document.getElementById('ptitle').textContent = 'No track selected';
    document.getElementById('partist').textContent = '—';
    document.getElementById('pfill').style.width = '0%';
    document.getElementById('cur').textContent = '0:00';
    document.getElementById('tot').textContent = '0:00';
    updateBtn();
  } else if (ci > idx) {
    ci--;
  }
  render();
  updateStorageInfo();
  showToast('Removed from library');
}

async function clearAll() {
  if (!tracks.length) return;
  if (!confirm(`Remove all ${tracks.length} songs from your library?`)) return;
  tracks.forEach(t => URL.revokeObjectURL(t.url));
  await dbClear();
  tracks = []; ci = -1; playing = false;
  aud.pause(); aud.src = '';
  document.getElementById('ptitle').textContent = 'No track selected';
  document.getElementById('partist').textContent = '—';
  document.getElementById('pfill').style.width = '0%';
  updateBtn();
  render();
  updateStorageInfo();
  showToast('Library cleared');
}

// ─── Storage info ─────────────────────────────────────────────────────────────
function updateStorageInfo() {
  const badge = document.getElementById('storageBadge');
  const info = document.getElementById('storageInfo');
  const clearBtn = document.getElementById('clearBtn');
  if (tracks.length === 0) {
    badge.style.display = 'none';
    clearBtn.style.display = 'none';
    return;
  }
  badge.style.display = 'flex';
  clearBtn.style.display = 'flex';
  const totalBytes = tracks.reduce((s, t) => s + (t.size || 0), 0);
  const mb = (totalBytes / 1024 / 1024).toFixed(1);
  info.textContent = `${tracks.length} song${tracks.length !== 1 ? 's' : ''} · ${mb} MB saved`;
}

// ─── Render ───────────────────────────────────────────────────────────────────
function fmt(s) { if (!s || isNaN(s)) return '—'; return `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`; }
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function render() {
  const tl = document.getElementById('tlist'), sb = document.getElementById('sbar');
  const hdr = document.getElementById('thdr'), cnt = document.getElementById('cnt');

  if (!tracks.length) {
    tl.innerHTML = `<div class="empty">${NOTE}<p>Your music will appear here</p></div>`;
    sb.innerHTML = `<div class="empty" style="padding:20px 0">${NOTE}<p>No songs yet</p></div>`;
    hdr.style.display = 'none';
    cnt.textContent = 'Add songs to get started';
    return;
  }

  hdr.style.display = 'grid';
  cnt.textContent = `${tracks.length} song${tracks.length !== 1 ? 's' : ''}`;

  tl.innerHTML = tracks.map((t, i) => `
    <div class="trow${i === ci ? ' active' : ''}" onclick="play(${i})">
      <div><div class="tr-num">${i+1}</div><div class="tr-bars">${BARS}</div></div>
      <div class="tr-info">
        <div class="tr-art">${NOTE}</div>
        <div class="tr-text"><h4>${esc(t.name)}</h4><span>Unknown Artist</span></div>
      </div>
      <div class="tr-date">${new Date(t.addedAt).toLocaleDateString()}</div>
      <div class="tr-dur-wrap">
        <span class="tr-dur">${t.dur}</span>
        <button class="tr-del" onclick="deleteTrack('${t.id}', event)" title="Remove">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>`).join('');

  sb.innerHTML = tracks.map((t, i) => `
    <div class="pitem${i === ci ? ' active' : ''}" onclick="play(${i})">
      <div class="pi-num">${i+1}</div>
      <div class="pi-bars">${BARS}</div>
      <div class="pi-art">${NOTE}</div>
      <div class="pi-info"><div class="pi-name">${esc(t.name)}</div><div class="pi-artist">Unknown Artist</div></div>
      <div class="pi-dur">${t.dur}</div>
      <button class="pi-del" onclick="deleteTrack('${t.id}', event)" title="Remove">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="16" y1="8" x2="8" y2="16"/><line x1="8" y1="8" x2="16" y2="16"/></svg>
      </button>
    </div>`).join('');
}

// ─── Playback ─────────────────────────────────────────────────────────────────
function play(i) {
  if (i < 0 || i >= tracks.length) return;
  ci = i;
  aud.src = tracks[i].url;
  aud.play();
  document.getElementById('ptitle').textContent = tracks[i].name;
  document.getElementById('partist').textContent = 'Unknown Artist';
  render();
}

function togglePlay() {
  if (!tracks.length) return;
  if (ci === -1) { play(0); return; }
  if (playing) aud.pause(); else aud.play();
}

function updateBtn() {
  const btn = document.getElementById('pbtn'), ico = document.getElementById('pico');
  if (playing) { btn.classList.add('playing'); ico.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'; }
  else { btn.classList.remove('playing'); ico.innerHTML = '<polygon points="5,3 19,12 5,21"/>'; }
}

function next() { if (!tracks.length) return; play(shuffle ? Math.floor(Math.random() * tracks.length) : (ci + 1) % tracks.length); }
function prev() { if (!tracks.length) return; if (aud.currentTime > 3) { aud.currentTime = 0; return; } play((ci - 1 + tracks.length) % tracks.length); }
function toggleShuffle() { shuffle = !shuffle; document.getElementById('shuf').classList.toggle('on', shuffle); }
function toggleRepeat() { repeat = !repeat; document.getElementById('rep').classList.toggle('on', repeat); }
function seek(e) { if (ci === -1 || !aud.duration) return; const r = document.getElementById('pbar').getBoundingClientRect(); aud.currentTime = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width)) * aud.duration; }
function setVol(e) { const r = document.getElementById('vs').getBoundingClientRect(); vol = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width)); aud.volume = vol; document.getElementById('vf').style.width = (vol * 100) + '%'; muted = false; updateVIcon(); }
function toggleMute() { muted = !muted; aud.muted = muted; updateVIcon(); }
function updateVIcon() { const v = document.getElementById('vico'); if (muted || vol === 0) v.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>'; else v.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>'; }

aud.addEventListener('timeupdate', () => { if (!aud.duration) return; document.getElementById('pfill').style.width = (aud.currentTime / aud.duration * 100) + '%'; document.getElementById('cur').textContent = fmt(aud.currentTime); document.getElementById('tot').textContent = fmt(aud.duration); });
aud.addEventListener('loadedmetadata', () => {
  if (ci >= 0 && tracks[ci].dur === '—') {
    tracks[ci].dur = fmt(aud.duration);
    // Save updated duration back to DB (data/ArrayBuffer already there, just updating dur field)
    dbPut(tracks[ci]);
    render();
  }
});
aud.addEventListener('ended', () => { if (repeat) { aud.currentTime = 0; aud.play(); } else next(); });
aud.addEventListener('play', () => { playing = true; updateBtn(); });
aud.addEventListener('pause', () => { playing = false; updateBtn(); });

// ─── Boot ─────────────────────────────────────────────────────────────────────
loadSavedTracks();

</script>
</body>
</html>
